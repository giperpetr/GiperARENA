name: Build and Deploy GiperARENA

on:
  push:
    branches: [master]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'realtime/**'
      - 'media/**'
      - 'blockchain/**'
      - 'shared/**'
      - 'docker-compose.prod.yml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: giperpetr/giperarena

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    strategy:
      matrix:
        service: [frontend, backend]
        # TODO: –î–æ–±–∞–≤–∏—Ç—å –∫–æ–≥–¥–∞ –±—É–¥—É—Ç –≥–æ—Ç–æ–≤—ã: realtime, media, blockchain
        include:
          - service: frontend
            context: .
            dockerfile: ./frontend/Dockerfile
            port: 3000
          - service: backend
            context: .
            dockerfile: ./backend/Dockerfile
            port: 3000
          # TODO: –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–≥–¥–∞ –±—É–¥—É—Ç –≥–æ—Ç–æ–≤—ã:
          # - service: realtime
          #   context: .
          #   dockerfile: ./realtime/Dockerfile
          #   port: 3001
          # - service: media
          #   context: .
          #   dockerfile: ./media/Dockerfile
          #   port: 3002
          # - service: blockchain
          #   context: .
          #   dockerfile: ./blockchain/Dockerfile
          #   port: 3003

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.title=${{ matrix.service }}
            org.opencontainers.image.description=GiperARENA ${{ matrix.service }} service
            org.opencontainers.image.vendor=GiperARENA

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:buildcache,mode=max
          build-args: |
            CACHEBUST=${{ github.sha }}

      - name: Image size report
        if: github.event_name != 'pull_request'
        run: |
          echo "üìä Image size report for ${{ matrix.service }}:"
          docker images ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:latest --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"

  deploy-to-server:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' && github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: üöÄ Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            # –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            cd /root/giperarena || {
              echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ /root/giperarena..."
              mkdir -p /root/giperarena
              cd /root/giperarena
            }

            # –í—Ö–æ–¥ –≤ GitHub Container Registry
            echo "üîë –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ GHCR..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # –ü–æ–ª—É—á–∞–µ–º –∫–æ—Ä–æ—Ç–∫–∏–π SHA (–ø–µ—Ä–≤—ã–µ 7 —Å–∏–º–≤–æ–ª–æ–≤)
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)

            # –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö –æ–±—Ä–∞–∑–æ–≤ —Å SHA —Ç–µ–≥–æ–º
            echo "üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö SLIM –æ–±—Ä–∞–∑–æ–≤ (SHA: ${SHORT_SHA})..."
            docker pull ghcr.io/giperpetr/giperarena/frontend:master-${SHORT_SHA}
            docker pull ghcr.io/giperpetr/giperarena/backend:master-${SHORT_SHA}

            # –¢–µ–≥–∏—Ä—É–µ–º –∫–∞–∫ latest –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            docker tag ghcr.io/giperpetr/giperarena/frontend:master-${SHORT_SHA} ghcr.io/giperpetr/giperarena/frontend:latest
            docker tag ghcr.io/giperpetr/giperarena/backend:master-${SHORT_SHA} ghcr.io/giperpetr/giperarena/backend:latest

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ –æ–±—Ä–∞–∑–æ–≤
            echo "üìä –†–∞–∑–º–µ—Ä—ã SLIM –æ–±—Ä–∞–∑–æ–≤:"
            docker images ghcr.io/giperpetr/giperarena/* --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"

            # –°–æ–∑–¥–∞–Ω–∏–µ docker-compose.prod.yml
            echo "üìã –°–æ–∑–¥–∞–Ω–∏–µ production –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
            cat > docker-compose.prod.yml << 'COMPOSE_EOF'
            name: giperarena

            services:
              frontend:
                image: ghcr.io/giperpetr/giperarena/frontend:latest
                container_name: giperarena-frontend
                restart: unless-stopped
                environment:
                  - NODE_ENV=production
                  - PORT=3000
                  - HOSTNAME=0.0.0.0
                  - NEXT_PUBLIC_API_URL=https://api.giperarena.space
                  - NEXT_PUBLIC_WS_URL=wss://ws.giperarena.space
                  - NEXT_PUBLIC_MEDIA_URL=https://media.giperarena.space
                  - NEXT_PUBLIC_SUPABASE_URL=https://api.gipergiraffe.com
                  - NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.ANON_KEY }}
                networks:
                  - proxy
                labels:
                  - "traefik.enable=true"
                  - "traefik.docker.network=proxy"
                  - "traefik.http.routers.giperarena-frontend.rule=Host(`giperarena.space`)"
                  - "traefik.http.routers.giperarena-frontend.entrypoints=websecure"
                  - "traefik.http.routers.giperarena-frontend.tls.certresolver=letsencrypt"
                  - "traefik.http.services.giperarena-frontend.loadbalancer.server.port=3000"
                  - "traefik.http.middlewares.giperarena-frontend-compress.compress=true"
                  - "traefik.http.routers.giperarena-frontend.middlewares=giperarena-frontend-compress"
                healthcheck:
                  test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s

              backend:
                image: ghcr.io/giperpetr/giperarena/backend:latest
                container_name: giperarena-backend
                restart: unless-stopped
                environment:
                  - NODE_ENV=production
                  - PORT=3000
                  - DATABASE_URL=postgresql://postgres.giper_prod:${{ secrets.POSTGRES_PASSWORD }}@supavisor:5432/postgres
                  - REDIS_URL=redis://:${{ secrets.REDIS_PASSWORD }}@queue-redis:6379/2
                  - S3_ENDPOINT=http://minio:9000
                  - S3_ACCESS_KEY=${{ secrets.MINIO_ROOT_USER }}
                  - S3_SECRET_KEY=${{ secrets.MINIO_ROOT_PASSWORD }}
                  - S3_BUCKET=giperarena
                  - SUPABASE_URL=https://api.gipergiraffe.com
                  - SUPABASE_ANON_KEY=${{ secrets.ANON_KEY }}
                  - SUPABASE_SERVICE_KEY=${{ secrets.SERVICE_ROLE_KEY }}
                  - JWT_SECRET=${{ secrets.JWT_SECRET }}
                networks:
                  - proxy
                  - supabase_default
                labels:
                  - "traefik.enable=true"
                  - "traefik.docker.network=proxy"
                  - "traefik.http.routers.giperarena-api.rule=Host(`api.giperarena.space`)"
                  - "traefik.http.routers.giperarena-api.entrypoints=websecure"
                  - "traefik.http.routers.giperarena-api.tls.certresolver=letsencrypt"
                  - "traefik.http.services.giperarena-api.loadbalancer.server.port=3000"
                healthcheck:
                  test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3

            networks:
              proxy:
                external: true
              supabase_default:
                external: true
            COMPOSE_EOF

            # –í–∞–ª–∏–¥–∞—Ü–∏—è docker-compose.prod.yml
            echo "üß™ –í–∞–ª–∏–¥–∞—Ü–∏—è docker-compose.prod.yml..."
            docker compose -f docker-compose.prod.yml config || {
              echo "‚ùå –û—à–∏–±–∫–∞ –≤ docker-compose.prod.yml"
              cat docker-compose.prod.yml
              exit 1
            }

            # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            docker compose -f docker-compose.prod.yml down --remove-orphans || true

            # –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ "–ø—Ä–∏–∑—Ä–∞—á–Ω—ã—Ö" endpoints –≤ —Å–µ—Ç–∏ proxy
            echo "üßπ –û—á–∏—Å—Ç–∫–∞ endpoints –≤ —Å–µ—Ç–∏ proxy..."
            docker network disconnect -f proxy giperarena-frontend 2>/dev/null || true
            docker network disconnect -f proxy giperarena-backend 2>/dev/null || true

            # –ó–∞–ø—É—Å–∫ –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo "üöÄ –ó–∞–ø—É—Å–∫ –Ω–æ–≤—ã—Ö SLIM –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            docker compose -f docker-compose.prod.yml up -d

            # –ö–†–ò–¢–ò–ß–ù–û: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∫ —Å–µ—Ç–∏ proxy –¥–ª—è Traefik
            echo "üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∫ —Å–µ—Ç–∏ proxy..."
            sleep 5  # –î–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º –≤—Ä–µ–º—è –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
            docker network connect proxy giperarena-frontend
            docker network connect proxy giperarena-backend

            # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
            echo "‚è±Ô∏è –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤..."
            sleep 45

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤..."
            docker compose -f docker-compose.prod.yml ps

            # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–µ—Ç–∏ proxy
            echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–µ—Ç–∏ proxy..."
            docker network ls | grep proxy || echo "‚ö†Ô∏è –°–µ—Ç—å proxy –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
            docker network inspect proxy 2>/dev/null | grep -A 5 "Containers" || echo "‚ö†Ô∏è –ù–µ –º–æ–≥—É –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ —Å–µ—Ç–∏ proxy"

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ labels –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Traefik labels..."
            docker inspect giperarena-frontend | grep -A 20 "Labels" || true
            docker inspect giperarena-backend | grep -A 20 "Labels" || true

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
            echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å—Ç—Ä–æ–∫)..."
            docker compose -f docker-compose.prod.yml logs --tail=30 frontend || true
            docker compose -f docker-compose.prod.yml logs --tail=30 backend || true

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –¥–æ–º–µ–Ω—ã
            echo "üåç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏..."
            curl -k -I https://giperarena.space/ || echo "Frontend –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
            curl -k -I https://api.giperarena.space/health || echo "Backend API –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

            # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤
            echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤..."
            docker image prune -f

            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!"
