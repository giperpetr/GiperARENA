name: Build and Deploy GiperARENA

on:
  push:
    branches: [master]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'realtime/**'
      - 'media/**'
      - 'blockchain/**'
      - 'shared/**'
      - 'docker-compose.prod.yml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: giperpetr/giperarena

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    strategy:
      matrix:
        service: [frontend, backend]
        # TODO: Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð³Ð´Ð° Ð±ÑƒÐ´ÑƒÑ‚ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹: realtime, media, blockchain
        include:
          - service: frontend
            context: .
            dockerfile: ./frontend/Dockerfile
            port: 3000
          - service: backend
            context: .
            dockerfile: ./backend/Dockerfile
            port: 3000
          # TODO: Ð Ð°ÑÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ¾Ð³Ð´Ð° Ð±ÑƒÐ´ÑƒÑ‚ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹:
          # - service: realtime
          #   context: .
          #   dockerfile: ./realtime/Dockerfile
          #   port: 3001
          # - service: media
          #   context: .
          #   dockerfile: ./media/Dockerfile
          #   port: 3002
          # - service: blockchain
          #   context: .
          #   dockerfile: ./blockchain/Dockerfile
          #   port: 3003

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.title=${{ matrix.service }}
            org.opencontainers.image.description=GiperARENA ${{ matrix.service }} service
            org.opencontainers.image.vendor=GiperARENA

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:buildcache,mode=max
          build-args: |
            CACHEBUST=${{ github.sha }}

      - name: Image size report
        if: github.event_name != 'pull_request'
        run: |
          echo "ðŸ“Š Image size report for ${{ matrix.service }}:"
          docker images ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:latest --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"

  deploy-to-server:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' && github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ðŸš€ Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð² Ñ€Ð°Ð±Ð¾Ñ‡ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
            cd /root/giperarena || {
              echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ /root/giperarena..."
              mkdir -p /root/giperarena
              cd /root/giperarena
            }

            # Ð’Ñ…Ð¾Ð´ Ð² GitHub Container Registry
            echo "ðŸ”‘ ÐÐ²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð² GHCR..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¹ SHA (Ð¿ÐµÑ€Ð²Ñ‹Ðµ 7 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²)
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)

            # Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð½Ð¾Ð²Ñ‹Ñ… Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² Ñ SHA Ñ‚ÐµÐ³Ð¾Ð¼
            echo "ðŸ“¦ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð½Ð¾Ð²Ñ‹Ñ… SLIM Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² (SHA: ${SHORT_SHA})..."
            docker pull ghcr.io/giperpetr/giperarena/frontend:master-${SHORT_SHA}
            docker pull ghcr.io/giperpetr/giperarena/backend:master-${SHORT_SHA}

            # Ð¢ÐµÐ³Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ°Ðº latest Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸
            docker tag ghcr.io/giperpetr/giperarena/frontend:master-${SHORT_SHA} ghcr.io/giperpetr/giperarena/frontend:latest
            docker tag ghcr.io/giperpetr/giperarena/backend:master-${SHORT_SHA} ghcr.io/giperpetr/giperarena/backend:latest

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ€Ð¾Ð² Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²
            echo "ðŸ“Š Ð Ð°Ð·Ð¼ÐµÑ€Ñ‹ SLIM Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²:"
            docker images ghcr.io/giperpetr/giperarena/* --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"

            # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ docker-compose.prod.yml
            echo "ðŸ“‹ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ production ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."
            cat > docker-compose.prod.yml << 'COMPOSE_EOF'
            name: giperarena

            services:
              frontend:
                image: ghcr.io/giperpetr/giperarena/frontend:latest
                container_name: giperarena-frontend
                restart: unless-stopped
                environment:
                  - NODE_ENV=production
                  - PORT=3000
                  - HOSTNAME=0.0.0.0
                  - NEXT_PUBLIC_API_URL=https://api.giperarena.space
                  - NEXT_PUBLIC_WS_URL=wss://ws.giperarena.space
                  - NEXT_PUBLIC_MEDIA_URL=https://media.giperarena.space
                  - NEXT_PUBLIC_SUPABASE_URL=https://api.gipergiraffe.com
                  - NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.ANON_KEY }}
                networks:
                  - proxy
                labels:
                  - "traefik.enable=true"
                  - "traefik.docker.network=proxy"
                  - "traefik.http.routers.giperarena-frontend.rule=Host(`giperarena.space`)"
                  - "traefik.http.routers.giperarena-frontend.entrypoints=websecure"
                  - "traefik.http.routers.giperarena-frontend.tls.certresolver=letsencrypt"
                  - "traefik.http.services.giperarena-frontend.loadbalancer.server.port=3000"
                  - "traefik.http.middlewares.giperarena-frontend-compress.compress=true"
                  - "traefik.http.routers.giperarena-frontend.middlewares=giperarena-frontend-compress"
                healthcheck:
                  test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s

              backend:
                image: ghcr.io/giperpetr/giperarena/backend:latest
                container_name: giperarena-backend
                restart: unless-stopped
                environment:
                  - NODE_ENV=production
                  - PORT=3000
                  - DATABASE_URL=postgresql://postgres.giper_prod:${{ secrets.POSTGRES_PASSWORD }}@supavisor:5432/postgres
                  - REDIS_URL=redis://:${{ secrets.REDIS_PASSWORD }}@queue-redis:6379/2
                  - S3_ENDPOINT=http://minio:9000
                  - S3_ACCESS_KEY=${{ secrets.MINIO_ROOT_USER }}
                  - S3_SECRET_KEY=${{ secrets.MINIO_ROOT_PASSWORD }}
                  - S3_BUCKET=giperarena
                  - SUPABASE_URL=https://api.gipergiraffe.com
                  - SUPABASE_ANON_KEY=${{ secrets.ANON_KEY }}
                  - SUPABASE_SERVICE_KEY=${{ secrets.SERVICE_ROLE_KEY }}
                  - JWT_SECRET=${{ secrets.JWT_SECRET }}
                networks:
                  - proxy
                  - supabase_default
                labels:
                  - "traefik.enable=true"
                  - "traefik.docker.network=proxy"
                  - "traefik.http.routers.giperarena-api.rule=Host(`api.giperarena.space`)"
                  - "traefik.http.routers.giperarena-api.entrypoints=websecure"
                  - "traefik.http.routers.giperarena-api.tls.certresolver=letsencrypt"
                  - "traefik.http.services.giperarena-api.loadbalancer.server.port=3000"
                healthcheck:
                  test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3

            networks:
              proxy:
                external: true
              supabase_default:
                external: true
            COMPOSE_EOF

            # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ docker-compose.prod.yml
            echo "ðŸ§ª Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ docker-compose.prod.yml..."
            docker compose -f docker-compose.prod.yml config || {
              echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð² docker-compose.prod.yml"
              cat docker-compose.prod.yml
              exit 1
            }

            # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
            echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
            docker compose -f docker-compose.prod.yml down --remove-orphans || true

            # Ð—Ð°Ð¿ÑƒÑÐº Ð½Ð¾Ð²Ñ‹Ñ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
            echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð½Ð¾Ð²Ñ‹Ñ… SLIM ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
            docker compose -f docker-compose.prod.yml up -d

            # ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°
            echo "â±ï¸ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
            sleep 45

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
            echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
            docker compose -f docker-compose.prod.yml ps

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¾Ð³Ð¾Ð²
            echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¾Ð³Ð¾Ð² (Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 30 ÑÑ‚Ñ€Ð¾Ðº)..."
            docker compose -f docker-compose.prod.yml logs --tail=30 frontend || true
            docker compose -f docker-compose.prod.yml logs --tail=30 backend || true

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ Ñ‡ÐµÑ€ÐµÐ· Ð´Ð¾Ð¼ÐµÐ½Ñ‹
            echo "ðŸŒ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸..."
            curl -k -I https://giperarena.space/ || echo "Frontend Ð¿Ð¾ÐºÐ° Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½"
            curl -k -I https://api.giperarena.space/health || echo "Backend API Ð¿Ð¾ÐºÐ° Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½"

            # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²
            echo "ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²..."
            docker image prune -f

            echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
